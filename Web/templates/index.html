<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢-–ë–∞–Ω–∫ | –†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0A0A0A 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
        }
        
        /* Auth Screen */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-box {
            background: linear-gradient(135deg, #1F1F1F 0%, #2A2A2A 100%);
            border-radius: 24px;
            padding: 48px;
            max-width: 450px;
            width: 100%;
            border: 2px solid #333;
            box-shadow: 0 20px 60px rgba(255, 221, 45, 0.1);
        }
        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        .auth-logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FFDD2D 0%, #FFC700 100%);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #000;
            font-size: 40px;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px rgba(255, 221, 45, 0.3);
        }
        .auth-title {
            font-size: 1.8em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #FFDD2D 0%, #FFF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .auth-subtitle {
            text-align: center;
            color: #999;
            font-size: 1em;
            margin-bottom: 32px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #999;
            font-size: 14px;
            font-weight: 600;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #333;
            border-radius: 12px;
            font-size: 15px;
            background: #0A0A0A;
            color: #fff;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #FFDD2D;
            box-shadow: 0 0 0 3px rgba(255, 221, 45, 0.1);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .btn-primary {
            background: linear-gradient(135deg, #FFDD2D 0%, #FFC700 100%);
            color: #000;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 221, 45, 0.4);
        }
        .btn-secondary {
            background: #2A2A2A;
            color: #fff;
            margin-top: 12px;
        }
        .btn-secondary:hover {
            background: #333;
        }
        .btn-success { background: #2DD36F; color: #000; }
        .btn-success:hover { background: #26b861; transform: translateY(-1px); }
        .btn-danger { background: #FF3B30; color: #fff; }
        .btn-danger:hover { background: #e6342a; transform: translateY(-1px); }
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
            width: auto;
        }
        
        /* Main App */
        .app { max-width: 1200px; margin: 0 auto; display: none; }
        .app.active { display: block; }
        
        .header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }
        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .tbank-logo {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #FFDD2D 0%, #FFC700 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #000;
            font-size: 22px;
        }
        .header h1 { 
            font-size: 1.4em; 
            font-weight: 700;
            background: linear-gradient(135deg, #FFDD2D 0%, #FFF 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FFDD2D 0%, #FFC700 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #000;
        }
        .btn-logout {
            background: #2A2A2A;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-logout:hover {
            background: #333;
        }
        
        .nav {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            display: flex;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 81px;
            z-index: 999;
            overflow-x: auto;
        }
        .nav-btn {
            flex: 1;
            min-width: 120px;
            padding: 16px 20px;
            border: none;
            background: transparent;
            color: #999;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.05); color: #fff; }
        .nav-btn.active { color: #FFDD2D; border-bottom-color: #FFDD2D; background: rgba(255, 221, 45, 0.05); }
        
        .content { padding: 24px 20px; min-height: calc(100vh - 200px); }
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: linear-gradient(135deg, #1F1F1F 0%, #2A2A2A 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .card h2 { 
            margin-bottom: 20px; 
            font-size: 1.4em; 
            font-weight: 700;
        }
        
        /* Parser Box */
        .parser-box {
            background: linear-gradient(135deg, #2A2A2A 0%, #1F1F1F 100%);
            border: 2px solid #FFDD2D;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 24px rgba(255, 221, 45, 0.1);
        }
        .parser-title {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 12px;
            color: #FFDD2D;
        }
        .parser-subtitle {
            color: #999;
            margin-bottom: 16px;
            font-size: 0.9em;
        }
        .url-input-group {
            display: flex;
            gap: 12px;
        }
        .url-input {
            flex: 1;
            padding: 14px 16px;
            border: 2px solid #333;
            border-radius: 12px;
            background: #0A0A0A;
            color: #fff;
            font-size: 15px;
        }
        .url-input:focus {
            outline: none;
            border-color: #FFDD2D;
        }
        .btn-parse {
            padding: 14px 24px;
            background: linear-gradient(135deg, #FFDD2D 0%, #FFC700 100%);
            color: #000;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .btn-parse:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 221, 45, 0.4);
        }
        .parser-result {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #0A0A0A;
            border-radius: 12px;
            border: 2px solid #333;
        }
        .parser-result.active { display: block; }
        .product-preview {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .product-image {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            object-fit: cover;
            background: #2A2A2A;
            flex-shrink: 0;
        }
        .product-details { flex: 1; }
        .product-name { 
            font-size: 1.1em; 
            font-weight: 700; 
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .product-price {
            font-size: 1.6em;
            color: #FFDD2D;
            font-weight: 800;
            margin-bottom: 12px;
        }
        .product-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .product-tag {
            background: #2A2A2A;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85em;
        }
        
        /* Impulse Analysis */
        .impulse-meter {
            margin: 20px 0;
            padding: 20px;
            background: #0A0A0A;
            border-radius: 12px;
            border: 1px solid #333;
        }
        .impulse-label {
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 1.05em;
        }
        .impulse-bar-container {
            width: 100%;
            height: 40px;
            background: #2A2A2A;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }
        .impulse-bar {
            height: 100%;
            border-radius: 20px;
            transition: width 0.8s ease-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 16px;
            font-weight: 800;
            font-size: 1.1em;
        }
        .impulse-bar.low { background: linear-gradient(90deg, #2DD36F, #24b35f); }
        .impulse-bar.medium { background: linear-gradient(90deg, #FFDD2D, #ffcc00); color: #000; }
        .impulse-bar.high { background: linear-gradient(90deg, #FF3B30, #cc2f26); }
        .impulse-reasons {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #333;
        }
        .impulse-reason {
            padding: 10px 14px;
            margin-bottom: 8px;
            background: #1F1F1F;
            border-radius: 8px;
            border-left: 3px solid #FFDD2D;
            font-size: 0.95em;
        }
        
        /* Purchase Items */
        .purchase-item {
            background: linear-gradient(135deg, #1F1F1F 0%, #252525 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 2px solid #333;
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
        }
        .purchase-item:hover {
            border-color: #444;
            transform: translateY(-2px);
        }
        .purchase-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #FFDD2D;
        }
        .purchase-item.blacklisted::before { background: #FF3B30; }
        .purchase-item.approved::before { background: #2DD36F; }
        .purchase-item.rejected::before { background: #666; }
        
        .purchase-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 16px;
            margin-bottom: 12px;
        }
        .purchase-name { 
            font-size: 1.1em; 
            font-weight: 700; 
            line-height: 1.3;
            flex: 1;
        }
        .purchase-price {
            font-size: 1.3em;
            font-weight: 800;
            color: #FFDD2D;
            white-space: nowrap;
        }
        .purchase-meta {
            display: flex;
            gap: 8px;
            margin: 8px 0;
            font-size: 0.85em;
            color: #999;
            flex-wrap: wrap;
        }
        .purchase-meta span {
            background: #2A2A2A;
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: 700;
            margin: 8px 0;
        }
        .badge-warning { 
            background: rgba(255, 221, 45, 0.15); 
            color: #FFDD2D; 
            border: 1px solid rgba(255, 221, 45, 0.3);
        }
        .badge-danger { 
            background: rgba(255, 59, 48, 0.15); 
            color: #FF3B30;
            border: 1px solid rgba(255, 59, 48, 0.3);
        }
        .badge-success { 
            background: rgba(45, 211, 111, 0.15); 
            color: #2DD36F;
            border: 1px solid rgba(45, 211, 111, 0.3);
        }
        
        .purchase-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .purchase-actions .btn { 
            flex: 1; 
            min-width: 120px;
        }
        
        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: linear-gradient(135deg, #1F1F1F 0%, #2A2A2A 100%);
            padding: 20px;
            border-radius: 16px;
            border: 2px solid #333;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: 800;
            color: #FFDD2D;
            margin: 8px 0;
        }
        .stat-label {
            color: #999;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        /* Settings */
        .range-item {
            background: #0A0A0A;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .range-info {
            flex: 1;
            min-width: 200px;
        }
        .blacklist-item {
            background: #0A0A0A;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 2px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #2A2A2A;
            border-top-color: #FFDD2D;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #1F1F1F 0%, #2A2A2A 100%);
            border-radius: 24px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            border: 2px solid #333;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-close {
            background: #2A2A2A;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            color: #fff;
            font-size: 20px;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: #333;
        }
        
        @media (max-width: 768px) {
            .url-input-group { flex-direction: column; }
            .btn-parse { width: 100%; }
            .product-preview { flex-direction: column; }
            .product-image { width: 100%; height: 200px; }
            .purchase-header { flex-direction: column; }
            .purchase-price { font-size: 1.5em; }
            .header h1 { font-size: 1.1em; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-container">
        <div class="auth-box">
            <div class="auth-logo">
                <div class="auth-logo-icon">–¢</div>
                <h1 class="auth-title">–†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h1>
                <p class="auth-subtitle">–£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏–º–ø—É–ª—å—Å–∏–≤–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫ –æ—Ç –¢-–ë–∞–Ω–∫–∞</p>
            </div>
            
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>–ù–∏–∫–Ω–µ–π–º</label>
                    <input type="text" id="login-nickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º" required>
                </div>
                <button type="submit" class="btn btn-primary">üîì –í–æ–π—Ç–∏</button>
                <button type="button" class="btn btn-secondary" onclick="showRegister()">
                    ‚ú® –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                </button>
            </form>
            
            <form id="register-form" onsubmit="handleRegister(event)" style="display: none;">
                <div class="form-group">
                    <label>–ù–∏–∫–Ω–µ–π–º</label>
                    <input type="text" id="register-nickname" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º" required>
                </div>
                <div class="form-group">
                    <label>–ó–∞—Ä–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                    <input type="number" id="register-salary" placeholder="100000" value="100000" required>
                </div>
                <div class="form-group">
                    <label>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è (‚ÇΩ)</label>
                    <input type="number" id="register-savings" placeholder="20000" value="20000" required>
                </div>
                <div class="form-group">
                    <label>–¢–µ–∫—É—â–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è (‚ÇΩ)</label>
                    <input type="number" id="register-current" placeholder="50000" value="50000" required>
                </div>
                <button type="submit" class="btn btn-primary">‚ú® –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <button type="button" class="btn btn-secondary" onclick="showLogin()">
                    üîô –ù–∞–∑–∞–¥ –∫–æ –≤—Ö–æ–¥—É
                </button>
            </form>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="main-app" class="app">
        <div class="header">
            <div class="header-content">
                <div class="header-logo">
                    <div class="tbank-logo">–¢</div>
                    <h1>–†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</h1>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">–ü</div>
                    <span id="userName" style="font-weight: 600;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    <button class="btn-logout" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
        
        <nav class="nav">
            <button class="nav-btn active" onclick="showScreen('add')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="nav-btn" onclick="showScreen('pending')">üìã –û–∂–∏–¥–∞–Ω–∏–µ</button>
            <button class="nav-btn" onclick="showScreen('history')">üìä –ò—Å—Ç–æ—Ä–∏—è</button>
            <button class="nav-btn" onclick="showScreen('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </nav>
        
        <div class="content">
            <!-- Add Screen -->
            <div id="add-screen" class="screen active">
                <div class="parser-box">
                    <div class="parser-title">üîó –ê–Ω–∞–ª–∏–∑ –ø–æ —Å—Å—ã–ª–∫–µ</div>
                    <p class="parser-subtitle">
                        –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä —Å Wildberries –∏–ª–∏ Ozon –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                    </p>
                    <div class="url-input-group">
                        <input type="url" id="product-url" class="url-input" 
                               placeholder="https://www.wildberries.ru/catalog/...">
                        <button class="btn-parse" onclick="parseProductUrl()">üîç –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä</button>
                    </div>
                    
                    <div id="parser-result" class="parser-result"></div>
                </div>
                
                <div class="card">
                    <h2>‚ûï –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏</h2>
                    <form id="add-form" onsubmit="addPurchase(event)">
                        <div class="form-group">
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                            <input type="text" id="purchase-name" placeholder="iPhone 15 Pro" required>
                        </div>
                        <div class="form-group">
                            <label>–¶–µ–Ω–∞ (‚ÇΩ) *</label>
                            <input type="number" id="purchase-price" step="0.01" placeholder="89990" required>
                        </div>
                        <div class="form-group">
                            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                            <select id="purchase-category" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <option value="–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞">üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
                                <option value="–û–¥–µ–∂–¥–∞">üëï –û–¥–µ–∂–¥–∞</option>
                                <option value="–û–±—É–≤—å">üëü –û–±—É–≤—å</option>
                                <option value="–î–æ–º –∏ —Å–∞–¥">üè† –î–æ–º –∏ —Å–∞–¥</option>
                                <option value="–°–ø–æ—Ä—Ç">‚öΩ –°–ø–æ—Ä—Ç</option>
                                <option value="–ö—Ä–∞—Å–æ—Ç–∞">üíÑ –ö—Ä–∞—Å–æ—Ç–∞</option>
                                <option value="–ò–≥—Ä—É—à–∫–∏">üéÆ –ò–≥—Ä—É—à–∫–∏</option>
                                <option value="–ö–Ω–∏–≥–∏">üìö –ö–Ω–∏–≥–∏</option>
                                <option value="–ê–≤—Ç–æ–º–æ–±–∏–ª–∏">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª–∏</option>
                                <option value="–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</option>
                                <option value="–î—Ä—É–≥–æ–µ">üì¶ –î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>–ó–∞–º–µ—Ç–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <textarea id="purchase-notes" placeholder="–ü–æ—á–µ–º—É –≤—ã —Ö–æ—Ç–∏—Ç–µ —ç—Ç–æ –∫—É–ø–∏—Ç—å?"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">‚ú® –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫—É</button>
                    </form>
                </div>
            </div>
            
            <!-- Pending Screen -->
            <div id="pending-screen" class="screen">
                <div id="pending-list"></div>
            </div>
            
            <!-- History Screen -->
            <div id="history-screen" class="screen">
                <div class="stats-grid" id="stats-grid"></div>
                <div class="card">
                    <h2>üìä –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π</h2>
                    <div id="history-list"></div>
                </div>
            </div>
            
            <!-- Settings Screen -->
            <div id="settings-screen" class="screen">
                <!-- –î–æ–±–∞–≤—å –ü–ï–†–ï–î —Å–µ–∫—Ü–∏–µ–π "–ü—Ä–æ—Ñ–∏–ª—å" -->
                <div class="card">
                    <h2>üì± Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                    <div id="telegram-status" style="padding: 20px; background: #0A0A0A; border-radius: 12px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div id="tg-status-icon" style="font-size: 2em;">‚ùå</div>
                            <div>
                                <div id="tg-status-text" style="font-weight: 600; font-size: 1.1em;">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>
                                <div style="color: #999; font-size: 0.9em;">–ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram</div>
                            </div>
                        </div>
                        <div id="tg-instructions" style="display: none; padding: 16px; background: #1F1F1F; border-radius: 8px; border-left: 3px solid #FFDD2D;">
                            <p style="margin-bottom: 8px; font-weight: 600;">üìù –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å:</p>
                            <ol style="margin-left: 20px; color: #999; font-size: 0.9em;">
                                <li>–ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞: <code style="background: #2A2A2A; padding: 2px 6px; border-radius: 4px;">@YourBotName</code></li>
                                <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É: <code style="background: #2A2A2A; padding: 2px 6px; border-radius: 4px;">/start</code></li>
                                <li>–ü—Ä–∏–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç: <code style="background: #2A2A2A; padding: 2px 6px; border-radius: 4px;">/link <span id="user-nick">–≤–∞—à_–Ω–∏–∫–Ω–µ–π–º</span></code></li>
                            </ol>
                        </div>
                        <button class="btn btn-primary" onclick="toggleTgInstructions()" style="width: 100%; margin-top: 12px;">
                            üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é
                        </button>
                    </div>
                </div>
                <div class="card">
                    <h2>üí§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
                    <form id="profile-form" onsubmit="updateProfile(event)">
                        <div class="form-group">
                            <label>üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞ (‚ÇΩ)</label>
                            <input type="number" id="profile-salary" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>üíµ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è (‚ÇΩ)</label>
                            <input type="number" id="profile-savings" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>üè¶ –¢–µ–∫—É—â–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è (‚ÇΩ)</label>
                            <input type="number" id="profile-current" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                    </form>
                </div>
                
                <div class="card">
                    <h2>üßä –î–∏–∞–ø–∞–∑–æ–Ω—ã –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è</h2>
                    <div id="price-ranges-list"></div>
                    <form id="add-range-form" onsubmit="addPriceRange(event)" style="margin-top: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px;">
                            <div class="form-group" style="margin: 0;">
                                <label>–û—Ç (‚ÇΩ)</label>
                                <input type="number" id="range-min" step="0.01" required>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>–î–æ (‚ÇΩ)</label>
                                <input type="number" id="range-max" step="0.01" placeholder="–ë–µ–∑ –ª–∏–º–∏—Ç–∞">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>–î–Ω–µ–π</label>
                                <input type="number" id="range-days" required>
                            </div>
                            <div style="align-self: end;">
                                <button type="submit" class="btn btn-primary btn-small">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h2>üö´ –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h2>
                    <div id="blacklist-list"></div>
                    <form id="add-blacklist-form" onsubmit="addBlacklist(event)" style="margin-top: 16px;">
                        <div style="display: flex; gap: 12px;">
                            <select id="blacklist-category" class="form-group" style="flex: 1; margin: 0;" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                <option value="–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞">üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
                                <option value="–û–¥–µ–∂–¥–∞">üëï –û–¥–µ–∂–¥–∞</option>
                                <option value="–û–±—É–≤—å">üëü –û–±—É–≤—å</option>
                                <option value="–î–æ–º –∏ —Å–∞–¥">üè† –î–æ–º –∏ —Å–∞–¥</option>
                                <option value="–°–ø–æ—Ä—Ç">‚öΩ –°–ø–æ—Ä—Ç</option>
                                <option value="–ö—Ä–∞—Å–æ—Ç–∞">üíÑ –ö—Ä–∞—Å–æ—Ç–∞</option>
                                <option value="–ò–≥—Ä—É—à–∫–∏">üéÆ –ò–≥—Ä—É—à–∫–∏</option>
                                <option value="–ö–Ω–∏–≥–∏">üìö –ö–Ω–∏–≥–∏</option>
                                <option value="–ê–≤—Ç–æ–º–æ–±–∏–ª–∏">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª–∏</option>
                                <option value="–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è">‚úàÔ∏è –ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</option>
                            </select>
                            <button type="submit" class="btn btn-danger btn-small">–ó–∞–ø—Ä–µ—Ç–∏—Ç—å</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Result Modal -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä –ê–Ω–∞–ª–∏–∑ –ø–æ–∫—É–ø–∫–∏</h2>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div id="result-content"></div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        
        // Auth Functions
        async function handleLogin(e) {
            e.preventDefault();
            const nickname = document.getElementById('login-nickname').value.trim();
            
            if (!nickname) return;
            
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    currentUser = data.user;
                    showApp();
                } else {
                    alert('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.');
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                console.error(error);
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            const nickname = document.getElementById('register-nickname').value.trim();
            const salary = document.getElementById('register-salary').value;
            const monthly_savings = document.getElementById('register-savings').value;
            const current_savings = document.getElementById('register-current').value;
            
            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        nickname, 
                        salary, 
                        monthly_savings,
                        current_savings,
                        use_savings_calculation: true
                    })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    currentUser = data.user;
                    showApp();
                } else {
                    const error = await res.json();
                    alert('‚ùå ' + error.error);
                }
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                console.error(error);
            }
        }
        
        function showApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').classList.add('active');
            document.getElementById('userName').textContent = currentUser.nickname;
            document.getElementById('userAvatar').textContent = currentUser.nickname[0].toUpperCase();
            loadPendingPurchases();
            loadStatistics();
        }
        
        function logout() {
            currentUser = null;
            document.getElementById('main-app').classList.remove('active');
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('login-form').reset();
        }
        
        function showLogin() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';
        }
        
        function showRegister() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('register-form').style.display = 'block';
        }
        
        // Product Parser
        async function parseProductUrl() {
            const url = document.getElementById('product-url').value.trim();
            if (!url) {
                alert('–í–≤–µ–¥–∏—Ç–µ URL —Ç–æ–≤–∞—Ä–∞');
                return;
            }
            
            const resultDiv = document.getElementById('parser-result');
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>–ü–∞—Ä—Å–∏–Ω–≥ —Ç–æ–≤–∞—Ä–∞...</p></div>';
            resultDiv.classList.add('active');
            
            try {
                const res = await fetch('/api/parse-product', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                const data = await res.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<div style="color:#FF3B30;text-align:center;padding:20px;">‚ùå ${data.error}</div>`;
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–∫—É–ø–∫—É
                const purchaseRes = await fetch('/api/purchases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        name: data.name,
                        price: data.price,
                        category: data.category,
                        product_url: url,
                        image_url: data.image_url
                    })
                });
                
                const purchaseData = await purchaseRes.json();
                const analysis = purchaseData.analysis;
                
                resultDiv.innerHTML = `
                    <div class="product-preview">
                        ${data.image_url ? `<img src="${data.image_url}" class="product-image" onerror="this.style.display='none'">` : ''}
                        <div class="product-details">
                            <div class="product-name">${data.name}</div>
                            <div class="product-price">${data.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            <div class="product-meta">
                                <span class="product-tag">üì¶ ${data.category}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="impulse-meter">
                        <div class="impulse-label">üìä –£—Ä–æ–≤–µ–Ω—å –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–∫—É–ø–∫–∏</div>
                        <div class="impulse-bar-container">
                            <div class="impulse-bar ${analysis.risk_level}" style="width: ${analysis.impulse_score}%">
                                ${analysis.impulse_score}%
                            </div>
                        </div>
                        <div style="margin-top:16px;font-size:1.15em;font-weight:700;text-align:center;color:${
                            analysis.risk_level === 'high' ? '#FF3B30' : 
                            analysis.risk_level === 'medium' ? '#FFDD2D' : '#2DD36F'
                        }">
                            ${analysis.emoji} ${analysis.recommendation}
                        </div>
                        ${analysis.reasons.length > 0 ? `
                            <div class="impulse-reasons">
                                <div style="font-weight:600;margin-bottom:10px;">–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞:</div>
                                ${analysis.reasons.map(r => `<div class="impulse-reason">${r}</div>`).join('')}
                            </div>
                        ` : ''}
                        <div style="margin-top:16px;padding:16px;background:#1F1F1F;border-radius:12px;text-align:center;">
                            <p style="margin-bottom:8px;"><strong>–ü–µ—Ä–∏–æ–¥ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è:</strong> ${analysis.cooling_days} –¥–Ω–µ–π</p>
                            <p style="font-size:0.9em;color:#999;">–†–µ—à–µ–Ω–∏–µ –º–æ–∂–Ω–æ –ø—Ä–∏–Ω—è—Ç—å –ø–æ—Å–ª–µ ${new Date(purchaseData.purchase.cooling_end_date).toLocaleDateString('ru-RU')}</p>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="showScreen('pending')" style="width:100%;margin-top:16px;">
                        üìã –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ–∂–∏–¥–∞–Ω–∏–µ
                    </button>
                `;
                
                document.getElementById('product-url').value = '';
                await loadPendingPurchases();
                
            } catch (error) {
                resultDiv.innerHTML = `<div style="color:#FF3B30;text-align:center;padding:20px;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                console.error(error);
            }
        }
        
        // Navigation
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${screenName}-screen`).classList.add('active');
            event.target.classList.add('active');
            
            if (screenName === 'pending') loadPendingPurchases();
            if (screenName === 'history') loadHistory();
            if (screenName === 'settings') loadSettings();
        }
        
        // Purchases
        async function addPurchase(e) {
            e.preventDefault();
            
            const name = document.getElementById('purchase-name').value;
            const price = parseFloat(document.getElementById('purchase-price').value);
            const category = document.getElementById('purchase-category').value;
            const notes = document.getElementById('purchase-notes').value;
            
            try {
                const res = await fetch('/api/purchases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        name, price, category, notes
                    })
                });
                
                const data = await res.json();
                showAnalysisModal(data);
                
                document.getElementById('add-form').reset();
                await loadPendingPurchases();
                
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏');
                console.error(error);
            }
        }
        
       // –î–æ–±–∞–≤—å—Ç–µ/–∑–∞–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é showAnalysisModal –≤ index.html

// –î–æ–±–∞–≤—å—Ç–µ/–∑–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ <script> —Å–µ–∫—Ü–∏—é index.html

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∞–Ω–∞–ª–∏–∑–æ–º –∏ –≤—ã–±–æ—Ä–æ–º
function showAnalysisModal(data) {
    const modal = document.getElementById('result-modal');
    const content = document.getElementById('result-content');
    const analysis = data.analysis;
    const purchase = data.purchase;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å
    const canAffordNow = analysis.can_afford;
    const isLowRisk = analysis.risk_level === 'low';
    const isMediumRisk = analysis.risk_level === 'medium';
    const isHighRisk = analysis.risk_level === 'high';
    const isBlacklisted = analysis.is_blacklisted;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –ø–ª–∞–Ω–æ–º
    let financialPlanHTML = '';
    
    if (analysis.savings_plan) {
        const plan = analysis.savings_plan;
        financialPlanHTML = `
            <div style="margin-top:20px;padding:20px;background:#0A0A0A;border-radius:12px;border:2px solid #FFDD2D;">
                <h3 style="margin-bottom:16px;color:#FFDD2D;font-size:1.1em;">üí∞ –ü–ª–∞–Ω –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</h3>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                    <div style="text-align:center;padding:12px;background:#1F1F1F;border-radius:8px;">
                        <div style="color:#999;font-size:0.85em;margin-bottom:4px;">–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç</div>
                        <div style="font-size:1.4em;font-weight:800;color:#FF3B30;">${plan.shortage.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                    <div style="text-align:center;padding:12px;background:#1F1F1F;border-radius:8px;">
                        <div style="color:#999;font-size:0.85em;margin-bottom:4px;">–î–Ω–µ–π –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</div>
                        <div style="font-size:1.4em;font-weight:800;color:#FFDD2D;">${plan.days_needed}</div>
                    </div>
                </div>
                
                <div style="padding:16px;background:#1F1F1F;border-radius:8px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="color:#999;">–û—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤ –¥–µ–Ω—å:</span>
                        <span style="font-weight:700;color:#FFDD2D;">${Math.round(plan.daily_savings).toLocaleString('ru-RU')} ‚ÇΩ</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="color:#999;">–û—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –≤ –º–µ—Å—è—Ü:</span>
                        <span style="font-weight:700;color:#FFDD2D;">${Math.round(plan.daily_savings * 30).toLocaleString('ru-RU')} ‚ÇΩ</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="color:#999;">–ú–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å:</span>
                        <span style="font-weight:700;color:#2DD36F;">${plan.target_date}</span>
                    </div>
                </div>
                
                ${plan.monthly_impact > 0 ? `
                    <div style="padding:12px;background:rgba(255,221,45,0.1);border-left:3px solid #FFDD2D;border-radius:4px;">
                        <div style="font-size:0.9em;color:#FFDD2D;">
                            üí° –ü–æ–∫—É–ø–∫–∞ —Å–æ—Å—Ç–∞–≤–∏—Ç ${plan.monthly_impact.toFixed(0)}% –æ—Ç –≤–∞—à–µ–≥–æ –º–µ—Å—è—á–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    // –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ
    let financialHealthHTML = '';
    if (analysis.financial_health) {
        const health = analysis.financial_health;
        const beforeMonths = health.before.savings_months;
        const afterMonths = health.after.savings_months;
        
        financialHealthHTML = `
            <div style="margin-top:20px;padding:20px;background:#0A0A0A;border-radius:12px;border:2px solid #333;">
                <h3 style="margin-bottom:16px;color:#fff;font-size:1.1em;">üìä –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                    <div style="padding:12px;background:#1F1F1F;border-radius:8px;text-align:center;">
                        <div style="color:#999;font-size:0.85em;margin-bottom:4px;">–î–æ –ø–æ–∫—É–ø–∫–∏</div>
                        <div style="font-size:1.2em;font-weight:700;color:#2DD36F;">
                            ${health.before.savings.toLocaleString('ru-RU')} ‚ÇΩ
                        </div>
                        <div style="color:#999;font-size:0.8em;margin-top:4px;">
                            (${beforeMonths.toFixed(1)} –º–µ—Å)
                        </div>
                    </div>
                    <div style="padding:12px;background:#1F1F1F;border-radius:8px;text-align:center;">
                        <div style="color:#999;font-size:0.85em;margin-bottom:4px;">–ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏</div>
                        <div style="font-size:1.2em;font-weight:700;color:${afterMonths < 1 ? '#FF3B30' : afterMonths < 3 ? '#FFDD2D' : '#2DD36F'};">
                            ${health.after.savings.toLocaleString('ru-RU')} ‚ÇΩ
                        </div>
                        <div style="color:#999;font-size:0.8em;margin-top:4px;">
                            (${afterMonths.toFixed(1)} –º–µ—Å)
                        </div>
                    </div>
                </div>
                
                ${afterMonths < 1 ? `
                    <div style="padding:12px;background:rgba(255,59,48,0.1);border-left:3px solid #FF3B30;border-radius:4px;">
                        <div style="font-size:0.9em;color:#FF3B30;">
                            ‚ö†Ô∏è –ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—É–¥–µ—Ç –º–µ–Ω—å—à–µ 1 –º–µ—Å—è—Ü–∞
                        </div>
                    </div>
                ` : afterMonths < 3 ? `
                    <div style="padding:12px;background:rgba(255,221,45,0.1);border-left:3px solid #FFDD2D;border-radius:4px;">
                        <div style="font-size:0.9em;color:#FFDD2D;">
                            üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–º–µ—Ç—å –ø–æ–¥—É—à–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –º–∏–Ω–∏–º—É–º 3-6 –º–µ—Å—è—Ü–µ–≤
                        </div>
                    </div>
                ` : `
                    <div style="padding:12px;background:rgba(45,211,111,0.1);border-left:3px solid #2DD36F;border-radius:4px;">
                        <div style="font-size:0.9em;color:#2DD36F;">
                            ‚úÖ –£ –≤–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ø–æ–¥—É—à–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                        </div>
                    </div>
                `}
            </div>
        `;
    }
    
    // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    let warningsHTML = '';
    if (analysis.financial_warnings && analysis.financial_warnings.length > 0) {
        warningsHTML = `
            <div style="margin-top:16px;padding:16px;background:rgba(255,221,45,0.05);border-radius:8px;border:1px solid rgba(255,221,45,0.2);">
                <div style="font-weight:600;margin-bottom:10px;color:#FFDD2D;">‚ö†Ô∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–∏—Å–∫–∏:</div>
                ${analysis.financial_warnings.map(w => `
                    <div style="padding:8px;margin-bottom:6px;background:#1F1F1F;border-radius:6px;font-size:0.9em;">
                        ${w}
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    // ===== –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô –í –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –û–¢ –°–ò–¢–£–ê–¶–ò–ò =====
    
    let actionButtonsHTML = '';
    
    if (isBlacklisted) {
        // –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ - —Ç–æ–ª—å–∫–æ —É–¥–∞–ª–∏—Ç—å
        actionButtonsHTML = `
            <div style="margin-top:24px;padding:20px;background:rgba(255,59,48,0.1);border:2px solid #FF3B30;border-radius:12px;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:48px;margin-bottom:8px;">üö´</div>
                    <h3 style="color:#FF3B30;margin-bottom:8px;">–ü–æ–∫—É–ø–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞</h3>
                    <p style="color:#999;font-size:0.9em;">–í—ã –¥–æ–±–∞–≤–∏–ª–∏ —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</p>
                </div>
                <button class="btn btn-danger" onclick="deletePurchaseFromModal(${purchase.id})" style="width:100%;">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞
                </button>
            </div>
        `;
    } else if (!canAffordNow) {
        // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ - —Ç–æ–ª—å–∫–æ –≤ –æ–∂–∏–¥–∞–Ω–∏–µ
        actionButtonsHTML = `
            <div style="margin-top:24px;padding:20px;background:#0A0A0A;border:2px solid #FFDD2D;border-radius:12px;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:48px;margin-bottom:8px;">üí∞</div>
                    <h3 style="color:#FFDD2D;margin-bottom:8px;">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤</h3>
                    <p style="color:#999;font-size:0.9em;">–ü–æ–∫—É–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è</p>
                </div>
                <button class="btn btn-primary" onclick="closeModal();showScreen('pending')" style="width:100%;">
                    üìã –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É –æ–∂–∏–¥–∞–Ω–∏—è
                </button>
            </div>
        `;
    } else if (isLowRisk) {
        // –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ - –≤—ã–±–æ—Ä: –∫—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å –∏–ª–∏ –≤ –æ–∂–∏–¥–∞–Ω–∏–µ
        actionButtonsHTML = `
            <div style="margin-top:24px;padding:20px;background:rgba(45,211,111,0.1);border:2px solid #2DD36F;border-radius:12px;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:48px;margin-bottom:8px;">üü¢</div>
                    <h3 style="color:#2DD36F;margin-bottom:8px;">–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ –ø–æ–∫—É–ø–∫–∏</h3>
                    <p style="color:#999;font-size:0.9em;">–£ –≤–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤, –ø–æ–∫—É–ø–∫–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –±—é–¥–∂–µ—Ç–∞</p>
                </div>
                
                <div style="display:grid;gap:12px;">
                    <button class="btn btn-success" onclick="approvePurchaseNow(${purchase.id})" style="width:100%;">
                        ‚úÖ –ö—É–ø–ª—é —Å–µ–π—á–∞—Å (–±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è)
                    </button>
                    <button class="btn" style="width:100%;background:#2A2A2A;color:#fff;" onclick="moveToPending(${purchase.id})">
                        ‚è∞ –ü–æ–¥–æ–∂–¥—É ${analysis.cooling_days} ${analysis.cooling_days === 1 ? '–¥–µ–Ω—å' : analysis.cooling_days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'} (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deletePurchaseFromModal(${purchase.id})" style="width:100%;">
                        üóëÔ∏è –ü–µ—Ä–µ–¥—É–º–∞–ª, —É–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        `;
    } else if (isMediumRisk) {
        // –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ - –≤—ã–±–æ—Ä —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
        actionButtonsHTML = `
            <div style="margin-top:24px;padding:20px;background:rgba(255,221,45,0.1);border:2px solid #FFDD2D;border-radius:12px;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:48px;margin-bottom:8px;">üü°</div>
                    <h3 style="color:#FFDD2D;margin-bottom:8px;">–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫</h3>
                    <p style="color:#999;font-size:0.9em;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –æ–±–¥—É–º–∞—Ç—å —ç—Ç—É –ø–æ–∫—É–ø–∫—É</p>
                </div>
                
                <div style="display:grid;gap:12px;">
                    <button class="btn btn-primary" onclick="moveToPending(${purchase.id})" style="width:100%;">
                        ‚è∞ –í —Å–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è (${analysis.cooling_days} ${analysis.cooling_days === 1 ? '–¥–µ–Ω—å' : analysis.cooling_days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'})
                    </button>
                    <button class="btn" style="width:100%;background:#2A2A2A;color:#fff;" onclick="confirmRiskyPurchase(${purchase.id})">
                        ‚ö†Ô∏è –í—Å—ë —Ä–∞–≤–Ω–æ –∫—É–ø–ª—é —Å–µ–π—á–∞—Å
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deletePurchaseFromModal(${purchase.id})" style="width:100%;">
                        üóëÔ∏è –ü–µ—Ä–µ–¥—É–º–∞–ª, —É–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        `;
    } else if (isHighRisk) {
        // –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ - —Ç–æ–ª—å–∫–æ –≤ –æ–∂–∏–¥–∞–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å
        actionButtonsHTML = `
            <div style="margin-top:24px;padding:20px;background:rgba(255,59,48,0.1);border:2px solid #FF3B30;border-radius:12px;">
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:48px;margin-bottom:8px;">üî¥</div>
                    <h3 style="color:#FF3B30;margin-bottom:8px;">–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫!</h3>
                    <p style="color:#999;font-size:0.9em;">–≠—Ç–∞ –ø–æ–∫—É–ø–∫–∞ –º–æ–∂–µ—Ç —Å–µ—Ä—å—ë–∑–Ω–æ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –≤–∞—à –±—é–¥–∂–µ—Ç</p>
                </div>
                
                <div style="display:grid;gap:12px;">
                    <button class="btn btn-primary" onclick="moveToPending(${purchase.id})" style="width:100%;">
                        ‚è∞ –í —Å–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è (${analysis.cooling_days} ${analysis.cooling_days === 1 ? '–¥–µ–Ω—å' : analysis.cooling_days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'})
                    </button>
                    <button class="btn btn-danger btn-small" onclick="deletePurchaseFromModal(${purchase.id})" style="width:100%;">
                        üóëÔ∏è –õ—É—á—à–µ –Ω–µ –Ω–∞–¥–æ, —É–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
                
                <div style="margin-top:12px;padding:12px;background:rgba(255,59,48,0.1);border-left:3px solid #FF3B30;border-radius:4px;">
                    <div style="font-size:0.85em;color:#FF3B30;">
                        ‚ö†Ô∏è –ü–æ–∫—É–ø–∫–∞ —Å–µ–π—á–∞—Å –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–¥—É–º–∞–π—Ç–µ –µ—ë –≤ –ø–µ—Ä–∏–æ–¥ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è.
                    </div>
                </div>
            </div>
        `;
    }
    
    content.innerHTML = `
        <div class="impulse-meter">
            <div class="impulse-label">üìä –£—Ä–æ–≤–µ–Ω—å –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç–∏: ${analysis.risk_description}</div>
            <div class="impulse-bar-container">
                <div class="impulse-bar ${analysis.risk_level}" style="width: ${analysis.impulse_score}%">
                    ${analysis.impulse_score}%
                </div>
            </div>
            <div style="margin-top:16px;font-size:1.2em;font-weight:700;text-align:center;color:${
                analysis.risk_level === 'high' ? '#FF3B30' : 
                analysis.risk_level === 'medium' ? '#000' : '#2DD36F'
            }">
                ${analysis.emoji} ${analysis.recommendation}
            </div>
            
            ${analysis.reasons.length > 0 ? `
                <div class="impulse-reasons">
                    <div style="font-weight:600;margin-bottom:10px;">–ü—Ä–∏—á–∏–Ω—ã –æ—Ü–µ–Ω–∫–∏:</div>
                    ${analysis.reasons.map(r => `<div class="impulse-reason">${r}</div>`).join('')}
                </div>
            ` : ''}
            
            ${warningsHTML}
        </div>
        
        ${financialPlanHTML}
        ${financialHealthHTML}
        ${actionButtonsHTML}
    `;
    
    modal.classList.add('active');
}

// –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å (–¥–ª—è –Ω–∏–∑–∫–æ–≥–æ —Ä–∏—Å–∫–∞)
async function approvePurchaseNow(purchaseId) {
    try {
        const res = await fetch(`/api/purchases/${purchaseId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'approved' })
        });
        
        if (res.ok) {
            closeModal();
            alert('‚úÖ –ü–æ–∫—É–ø–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞! –ü—Ä–∏—è—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è üéâ');
            await loadPendingPurchases();
            await loadStatistics();
            showScreen('history');
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –ø–æ–∫—É–ø–∫–∏');
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error(error);
    }
}

// –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –æ–∂–∏–¥–∞–Ω–∏–µ
async function moveToPending(purchaseId) {
    closeModal();
    alert('üìã –ü–æ–∫—É–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è');
    await loadPendingPurchases();
    showScreen('pending');
}

// –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ–π –ø–æ–∫—É–ø–∫–∏
async function confirmRiskyPurchase(purchaseId) {
    const confirmed = confirm(
        '‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã?\n\n' +
        '–≠—Ç–∞ –ø–æ–∫—É–ø–∫–∞ –∏–º–µ–µ—Ç —Å—Ä–µ–¥–Ω–∏–π/–≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞ –∏ –º–æ–∂–µ—Ç –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –≤–∞—à –±—é–¥–∂–µ—Ç.\n\n' +
        '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å –µ—ë –≤ —Å–ø–∏—Å–æ–∫ –æ–∂–∏–¥–∞–Ω–∏—è –∏ –æ–±–¥—É–º–∞—Ç—å –≤ –ø–µ—Ä–∏–æ–¥ –æ—Ö–ª–∞–∂–¥–µ–Ω–∏—è.\n\n' +
        '–í—Å—ë —Ä–∞–≤–Ω–æ –∫—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å?'
    );
    
    if (confirmed) {
        await approvePurchaseNow(purchaseId);
    }
}

// –£–¥–∞–ª–∏—Ç—å –ø–æ–∫—É–ø–∫—É –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
async function deletePurchaseFromModal(purchaseId) {
    const confirmed = confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–∫—É–ø–∫—É?');
    if (!confirmed) return;
    
    try {
        const res = await fetch(`/api/purchases/${purchaseId}`, {
            method: 'DELETE'
        });
        
        if (res.ok) {
            closeModal();
            alert('üóëÔ∏è –ü–æ–∫—É–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
            await loadPendingPurchases();
            await loadStatistics();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        console.error(error);
    }
}

    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ pending-list –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞
    function formatPurchaseItem(p) {
        const endDate = new Date(p.cooling_end_date);
        const now = new Date();
        const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
        const canDecide = daysLeft <= 0;
        
        let statusBadge = '';
        if (p.is_blacklisted) {
            statusBadge = '<span class="badge badge-danger">üö´ –í —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ</span>';
        } else if (canDecide) {
            statusBadge = '<span class="badge badge-success">‚úÖ –ú–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å</span>';
        } else {
            statusBadge = `<span class="badge badge-warning">‚è≥ –û—Å—Ç–∞–ª–æ—Å—å ${daysLeft} ${daysLeft === 1 ? '–¥–µ–Ω—å' : daysLeft < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}</span>`;
        }
        
        return `
            <div class="purchase-item ${p.is_blacklisted ? 'blacklisted' : p.status === 'approved' ? 'approved' : p.status === 'rejected' ? 'rejected' : ''}">
                <div class="purchase-header">
                    <div class="purchase-name">${p.name}</div>
                    <div class="purchase-price">${p.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                </div>
                <div class="purchase-meta">
                    <span>üì¶ ${p.category}</span>
                    <span>‚è±Ô∏è ${p.cooling_period_days} –¥–Ω</span>
                    <span>üìÖ ${endDate.toLocaleDateString('ru-RU')}</span>
                </div>
                ${statusBadge}
                ${p.notes ? `<div style="margin-top:8px;padding:12px;background:#0A0A0A;border-radius:8px;font-size:0.9em;color:#999;">üí≠ ${p.notes}</div>` : ''}
                ${p.product_url ? `<a href="${p.product_url}" target="_blank" style="color:#FFDD2D;margin-top:8px;display:inline-block;font-size:0.9em;">üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä</a>` : ''}
                <div class="purchase-actions">
                    ${canDecide && !p.is_blacklisted ? `
                        <button class="btn btn-success" onclick="updatePurchase(${p.id}, 'approved')">‚úÖ –ö—É–ø–ª—é</button>
                        <button class="btn btn-danger" onclick="updatePurchase(${p.id}, 'rejected')">‚ùå –û—Ç–∫–∞–∂—É—Å—å</button>
                    ` : p.is_blacklisted ? `
                        <button class="btn btn-danger" onclick="updatePurchase(${p.id}, 'rejected')">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
                    ` : `
                        <button class="btn btn-secondary" disabled>‚è≥ –ñ–¥–∏—Ç–µ ${daysLeft} ${daysLeft === 1 ? '–¥–µ–Ω—å' : daysLeft < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}</button>
                    `}
                    <button class="btn btn-danger btn-small" onclick="deletePurchase(${p.id})">üóëÔ∏è</button>
                </div>
            </div>
        `;
    }
        
        async function loadPendingPurchases() {
            const container = document.getElementById('pending-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
            
            try {
                const res = await fetch(`/api/purchases?user_id=${currentUser.id}&status=pending`);
                const purchases = await res.json();
                
                if (purchases.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <h3>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–æ–∫—É–ø–æ–∫</h3>
                            <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = purchases.map(p => {
                    const endDate = new Date(p.cooling_end_date);
                    const now = new Date();
                    const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));
                    const canDecide = daysLeft <= 0;
                    
                    return `
                        <div class="purchase-item ${p.is_blacklisted ? 'blacklisted' : ''}">
                            <div class="purchase-header">
                                <div class="purchase-name">${p.name}</div>
                                <div class="purchase-price">${p.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            </div>
                            <div class="purchase-meta">
                                <span>üì¶ ${p.category}</span>
                                <span>‚è±Ô∏è ${p.cooling_period_days} –¥–Ω</span>
                                <span>üìÖ ${endDate.toLocaleDateString('ru-RU')}</span>
                            </div>
                            ${p.is_blacklisted ? 
                                '<span class="badge badge-danger">üö´ –í —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ</span>' :
                                canDecide ?
                                    '<span class="badge badge-success">‚úÖ –ú–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å</span>' :
                                    `<span class="badge badge-warning">‚è≥ –û—Å—Ç–∞–ª–æ—Å—å ${daysLeft} –¥–Ω</span>`
                            }
                            ${p.notes ? `<div style="margin-top:8px;padding:12px;background:#0A0A0A;border-radius:8px;font-size:0.9em;color:#999;">üí≠ ${p.notes}</div>` : ''}
                            ${p.product_url ? `<a href="${p.product_url}" target="_blank" style="color:#FFDD2D;margin-top:8px;display:inline-block;font-size:0.9em;">üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä</a>` : ''}
                            <div class="purchase-actions">
                                ${canDecide && !p.is_blacklisted ? `
                                    <button class="btn btn-success" onclick="updatePurchase(${p.id}, 'approved')">‚úÖ –ö—É–ø–ª—é</button>
                                    <button class="btn btn-danger" onclick="updatePurchase(${p.id}, 'rejected')">‚ùå –û—Ç–∫–∞–∂—É—Å—å</button>
                                ` : p.is_blacklisted ? `
                                    <button class="btn btn-danger" onclick="updatePurchase(${p.id}, 'rejected')">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
                                ` : `
                                    <button class="btn btn-secondary" disabled>‚è≥ –ñ–¥–∏—Ç–µ ${daysLeft} –¥–Ω</button>
                                `}
                                <button class="btn btn-danger btn-small" onclick="deletePurchase(${p.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                container.innerHTML = '<div style="color:#FF3B30;text-align:center;padding:40px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                console.error(error);
            }
        }
        
        async function updatePurchase(id, status) {
            try {
                await fetch(`/api/purchases/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                await loadPendingPurchases();
                await loadStatistics();
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                console.error(error);
            }
        }
        
        async function deletePurchase(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø–æ–∫—É–ø–∫—É?')) return;
            try {
                await fetch(`/api/purchases/${id}`, { method: 'DELETE' });
                await loadPendingPurchases();
                await loadStatistics();
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                console.error(error);
            }
        }
        
        async function loadHistory() {
            await loadStatistics();
            const container = document.getElementById('history-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            try {
                const res = await fetch(`/api/purchases?user_id=${currentUser.id}`);
                const allPurchases = await res.json();
                const purchases = allPurchases.filter(p => p.status !== 'pending');
                
                if (purchases.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">üìä</div>
                            <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = purchases.map(p => `
                    <div class="purchase-item ${p.status === 'approved' ? 'approved' : 'rejected'}">
                        <div class="purchase-header">
                            <div class="purchase-name">${p.name}</div>
                            <div class="purchase-price">${p.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                        </div>
                        <div class="purchase-meta">
                            <span>üì¶ ${p.category}</span>
                            <span>üìÖ ${new Date(p.created_at).toLocaleDateString('ru-RU')}</span>
                        </div>
                        <span class="badge ${p.status === 'approved' ? 'badge-success' : 'badge-danger'}">
                            ${p.status === 'approved' ? '‚úÖ –ö—É–ø–ª–µ–Ω–æ' : '‚ùå –û—Ç–∫–∞–∑–∞–Ω–æ'}
                        </span>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = '<div style="color:#FF3B30;padding:20px;">‚ùå –û—à–∏–±–∫–∞</div>';
                console.error(error);
            }
        }
        
        async function loadStatistics() {
            try {
                const res = await fetch(`/api/statistics/${currentUser.id}`);
                const stats = await res.json();
                
                document.getElementById('stats-grid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">üìä –í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫</div>
                        <div class="stat-value">${stats.total}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">‚è≥ –û–∂–∏–¥–∞—é—Ç —Ä–µ—à–µ–Ω–∏—è</div>
                        <div class="stat-value">${stats.pending}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üí∏ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                        <div class="stat-value">${Math.round(stats.total_spent).toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">üí∞ –°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ</div>
                        <div class="stat-value" style="color:#2DD36F;">${Math.round(stats.total_saved).toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                `;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', error);
            }
        }
        
        async function loadSettings() {
            // Load profile
            document.getElementById('profile-salary').value = currentUser.salary;
            document.getElementById('profile-savings').value = currentUser.monthly_savings;
            document.getElementById('profile-current').value = currentUser.current_savings;
            
            // Load price ranges
            try {
                const res = await fetch(`/api/price-ranges/${currentUser.id}`);
                const ranges = await res.json();
                
                document.getElementById('price-ranges-list').innerHTML = ranges.map(r => `
                    <div class="range-item">
                        <div class="range-info">
                            <strong>${r.min_price.toLocaleString('ru-RU')} ‚ÇΩ</strong> - 
                            <strong>${r.max_price ? r.max_price.toLocaleString('ru-RU') + ' ‚ÇΩ' : '‚àû'}</strong>
                            ‚Üí <span style="color:#FFDD2D;">${r.cooling_days} –¥–Ω–µ–π</span>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deletePriceRange(${r.id})">üóëÔ∏è</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤', error);
            }
            
            // Load blacklist
            try {
                const res = await fetch(`/api/blacklist/${currentUser.id}`);
                const blacklist = await res.json();
                
                if (blacklist.length === 0) {
                    document.getElementById('blacklist-list').innerHTML = '<p style="color:#999;text-align:center;padding:20px;">–ù–µ—Ç –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π</p>';
                } else {
                    document.getElementById('blacklist-list').innerHTML = blacklist.map(b => `
                        <div class="blacklist-item">
                            <span>üö´ ${b.category}</span>
                            <button class="btn btn-danger btn-small" onclick="removeBlacklist(${b.id})">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ blacklist', error);
            }
        }

        async function loadTelegramStatus() {
            const statusIcon = document.getElementById('tg-status-icon');
            const statusText = document.getElementById('tg-status-text');
            
            if (currentUser.telegram_linked) {
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
                statusText.style.color = '#2DD36F';
                document.getElementById('tg-instructions').style.display = 'none';
            } else {
                statusIcon.textContent = '‚ùå';
                statusText.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
                statusText.style.color = '#FF3B30';
                document.getElementById('user-nick').textContent = currentUser.nickname;
            }
        }

        function toggleTgInstructions() {
            const instructions = document.getElementById('tg-instructions');
            instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
        }

        // –í—ã–∑—ã–≤–∞–π –≤ loadSettings():
        async function loadSettings() {
            // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
            
            loadTelegramStatus(); // –î–û–ë–ê–í–¨ –≠–¢–£ –°–¢–†–û–ö–£
        }
        
        async function updateProfile(e) {
            e.preventDefault();
            try {
                await fetch(`/api/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        salary: parseFloat(document.getElementById('profile-salary').value),
                        monthly_savings: parseFloat(document.getElementById('profile-savings').value),
                        current_savings: parseFloat(document.getElementById('profile-current').value)
                    })
                });
                
                // Update local user object
                currentUser.salary = parseFloat(document.getElementById('profile-salary').value);
                currentUser.monthly_savings = parseFloat(document.getElementById('profile-savings').value);
                currentUser.current_savings = parseFloat(document.getElementById('profile-current').value);
                
                alert('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!');
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                console.error(error);
            }
        }
        
        async function addPriceRange(e) {
            e.preventDefault();
            const min = parseFloat(document.getElementById('range-min').value);
            const max = document.getElementById('range-max').value ? parseFloat(document.getElementById('range-max').value) : null;
            const days = parseInt(document.getElementById('range-days').value);
            
            try {
                await fetch('/api/price-ranges', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        min_price: min,
                        max_price: max,
                        cooling_days: days
                    })
                });
                
                document.getElementById('add-range-form').reset();
                loadSettings();
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞');
                console.error(error);
            }
        }
        
        async function deletePriceRange(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω?')) return;
            try {
                await fetch(`/api/price-ranges/${id}`, { method: 'DELETE' });
                loadSettings();
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                console.error(error);
            }
        }
        
        async function addBlacklist(e) {
            e.preventDefault();
            const category = document.getElementById('blacklist-category').value;
            
            try {
                await fetch('/api/blacklist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        category: category
                    })
                });
                
                document.getElementById('add-blacklist-form').reset();
                loadSettings();
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                console.error(error);
            }
        }
        
        async function removeBlacklist(id) {
            try {
                await fetch(`/api/blacklist/${id}`, { method: 'DELETE' });
                loadSettings();
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                console.error(error);
            }
        }
        
        function closeModal() {
            document.getElementById('result-modal').classList.remove('active');
        }
    </script>
</body>
</html>